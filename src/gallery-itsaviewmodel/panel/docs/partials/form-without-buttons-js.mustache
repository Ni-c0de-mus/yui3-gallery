YUI(yuiconfig).use('node-base', 'gallery-itsaformmodel', 'gallery-itsaviewmodelpanel', function(Y) {
    var panel, user, template, footertemplate, spinnericon, retrylegend, firsterror = true;

    // loading asynchroniously the animated fonticon:
    Y.use('gallerycss-itsa-base', 'gallerycss-itsa-animatespin', 'gallerycss-itsa-controll');

    // create MyFormModelClass
    Y.LoginModel = Y.Base.create('formmodel', Y.ITSAFormModel, [], {
        sync: function (action, options, callback) {
            var instance = this;
            switch (action) {
              case 'submit':
                Y.later(1500, null, function() {
                    // normally you need to invest the response on the server,
                    // but now we do this here:
                    var loginok = ((instance.get('username')==='marco') &&
                                   (instance.get('password')==='asbreuk'));
                    if (loginok) {
                        callback();
                    }
                    else {
                        callback('Wrong username/password: try again');
                    }
                });
                return;
              default:
                callback('Invalid action');
            }
        }
    }, {
        ATTRS: {
            username: {
                formtype: 'text',
                formconfig: {
                    label: 'Username',
                    placeholder: 'username',
                    required: true,
                    initialfocus: true
                },
                validator: function(v) {
                    return (typeof v==='string') && (v.length>=3) && (v.indexOf(' ')===-1);
                },
                validationerror: 'Enter at least 3 characters without a whitespace'
            },
            password: {
                formtype: 'password',
                formconfig: {
                    label: 'Password',
                    placeholder: 'password',
                    required: true,
                    fullselect: true,
                    submitonenter: true
                },
                validator: function(v) {
                    return (typeof v==='string') && (v.length>=5) && (v.indexOf(' ')===-1);
                },
                validationerror: 'Enter at least 5 characters without a whitespace'
            }
        }
    });

    user = new Y.LoginModel();

    template = '<div id="spinner" class="hiddenicon">'+
                   '<i class="itsaicon-controll-spin7 animate-spin itsa-iconstandalone"></i>'+
               '</div>'+
               '<fieldset>'+
                   '<div class="pure-control-group">{username}</div>'+
                   '<div class="pure-control-group">{password}</div>'+
               '</fieldset>';

    templateretry = '<div id="spinner" class="hiddenicon extratop">'+
                        '<i class="itsaicon-controll-spin7 animate-spin itsa-iconstandalone"></i>'+
                    '</div>'+
                    '<legend id="retrylegend">{response}</legend>'+
                    '<fieldset>'+
                        '<div class="pure-control-group">{username}</div>'+
                        '<div class="pure-control-group">{password}</div>'+
                    '</fieldset>';

    footertemplate = '{spinbtn_submit}';

    panel = new Y.ITSAViewModelPanel({
        model: user,
        template: template,
        footerTemplate: footertemplate,
        title: 'Login with username=\'marco\', password=\'asbreuk\'',
        titleRight: '', // <-- hide closebutton
        hideOnBtn: false, // <-- make not to close when submitted ('submitonenter' acts like a button)
        centered: true,
        visible: true,
        modal: true,
        dragable: true,
        editable: true,
        width: 320
    }).render();

    spinnericon = Y.one('#spinner');

    user.on('submit', function(e) {
        var submitpromise = e.promise;
        spinnericon.removeClass('hiddenicon');
        retrylegend && retrylegend.set('text', 'Retry login');
        submitpromise.then(
            function() {
                panel.hide();
            },
            function(reason) {
                user.reset();
                if (firsterror) {
                    panel.set('template', Y.Lang.sub(templateretry, {response: reason.message}));
                    retrylegend = panel.get('contentBox').one('#retrylegend');
                    spinnericon = Y.one('#spinner'); // <-- redefine, became a new node
                    firsterror = false;
                }
                else {
                    retrylegend.set('text', reason.message);
                    panel.unlockPanel();
                }
                spinnericon.addClass('hiddenicon');
            }
        );
    });

});